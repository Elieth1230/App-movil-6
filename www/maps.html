<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa - Google Maps</title>
    <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
    <div class="map-header"> Ubicaci贸n Actual</div>
    <div id="map" style="height: calc(100vh - 60px); width: 100vw;"></div>
    
    <div class="map-controls">
        <button id="btn-location" class="control-btn location-btn" title="Obtener mi ubicaci贸n"></button>
    </div>
    <script>
        var map, marker;
        
        // Funci贸n para verificar permisos de ubicaci贸n
        function verificarPermisos() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('Estado del permiso de geolocalizaci贸n:', result.state);
                    if (result.state === 'denied') {
                        alert('Los permisos de ubicaci贸n est谩n denegados. Ve a Configuraci贸n > Apps > Proyecto6 > Permisos y habilita la Ubicaci贸n.');
                    }
                });
            }
        }
        
        function initMap() {
            var defaultCenter = { lat: 19.432608, lng: -99.133209 }; // CDMX por defecto
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 15,
                mapTypeId: 'roadmap',
                streetViewControl: false,
                fullscreenControl: false
            });
            marker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                title: 'Ubicaci贸n inicial',
                draggable: false
            });
            
            // Agregar info window para mostrar estado
            var infoWindow = new google.maps.InfoWindow({
                content: 'Obteniendo ubicaci贸n...'
            });
            
            // Verificar permisos primero
            verificarPermisos();
            
            // Intentar obtener ubicaci贸n inmediatamente
            obtenerUbicacionConFallback();
            
            document.getElementById('btn-location').addEventListener('click', function() {
                infoWindow.setContent('Actualizando ubicaci贸n...');
                infoWindow.open(map, marker);
                obtenerUbicacionConFallback();
            });
        }

        // Funci贸n mejorada para obtener ubicaci贸n con m煤ltiples intentos
        function obtenerUbicacionConFallback() {
            console.log('Iniciando obtenci贸n de ubicaci贸n...');
            
            if (!navigator.geolocation) {
                console.error('Geolocalizaci贸n no soportada');
                mostrarError('Geolocalizaci贸n no soportada por este dispositivo');
                return;
            }

            // Configuraci贸n m谩s agresiva para ubicaci贸n real
            const options = {
                enableHighAccuracy: true,
                timeout: 60000,  // 60 segundos
                maximumAge: 0,   // Sin cach茅
                // Opciones espec铆ficas de Cordova
                frequency: 1000,
                enableLocationManager: true
            };

            console.log('Usando configuraci贸n agresiva para ubicaci贸n real');
            
            // Usar watchPosition para mejor precisi贸n
            const watchId = navigator.geolocation.watchPosition(
                function(position) {
                    navigator.geolocation.clearWatch(watchId);
                    console.log('Ubicaci贸n obtenida:', position);
                    
                    // Verificar calidad de la ubicaci贸n
                    if (position.coords.accuracy > 1000) {
                        console.warn('Precisi贸n muy baja, reintentando...');
                        // Si la precisi贸n es muy mala, intentar de nuevo
                        setTimeout(obtenerUbicacionConFallback, 2000);
                        return;
                    }
                    
                    actualizarMapa(position);
                },
                function(error) {
                    navigator.geolocation.clearWatch(watchId);
                    console.error('Error obtenci贸n de ubicaci贸n:', error);
                    manejarErrorGeolocation(error);
                },
                options
            );
        }

        function usarCordovaGeolocation() {
            // Usar el plugin de Cordova para mejor precisi贸n
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('Ubicaci贸n obtenida via Cordova:', position);
                    actualizarMapa(position);
                },
                function(error) {
                    console.error('Error Cordova geolocation:', error);
                    // Fallback a navegador
                    usarNavegadorGeolocation();
                },
                {
                    enableHighAccuracy: true,
                    timeout: 30000,
                    maximumAge: 0
                }
            );
        }

        function usarNavegadorGeolocation() {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    console.log('Ubicaci贸n obtenida via navegador:', position);
                    actualizarMapa(position);
                },
                function(error) {
                    console.error('Error navegador geolocation:', error);
                    manejarErrorGeolocation(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 60000
                }
            );
        }

        function actualizarMapa(position) {
            var userPos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            console.log('Actualizando mapa con posici贸n:', userPos);
            
            map.setCenter(userPos);
            marker.setPosition(userPos);
            marker.setTitle(`Tu ubicaci贸n actual (Precisi贸n: ${Math.round(position.coords.accuracy)}m)`);
            
            // Mostrar info window con detalles
            var infoContent = `
                <div>
                    <strong>Ubicaci贸n actual</strong><br>
                    Lat: ${userPos.lat.toFixed(6)}<br>
                    Lng: ${userPos.lng.toFixed(6)}<br>
                    Precisi贸n: ${Math.round(position.coords.accuracy)}m
                </div>
            `;
            
            var infoWindow = new google.maps.InfoWindow({
                content: infoContent
            });
            infoWindow.open(map, marker);
            
            guardarUbicacion(userPos);
        }

        function manejarErrorGeolocation(error) {
            var errorMsg = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMsg = 'Permisos de ubicaci贸n denegados. Ve a Configuraci贸n > Apps > Proyecto6 > Permisos y habilita la Ubicaci贸n.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMsg = 'Informaci贸n de ubicaci贸n no disponible. Verifica que el GPS est茅 activado y que tengas se帽al.';
                    break;
                case error.TIMEOUT:
                    errorMsg = 'Tiempo de espera agotado. Verifica tu conexi贸n y el GPS.';
                    break;
                default:
                    errorMsg = 'Error desconocido al obtener ubicaci贸n.';
                    break;
            }
            mostrarError(errorMsg);
        }

        function mostrarError(mensaje) {
            console.error('Error geolocalizaci贸n:', mensaje);
            alert(mensaje);
            
            // Mostrar ubicaci贸n por defecto
            var fallbackPos = { lat: 19.432608, lng: -99.133209 };
            map.setCenter(fallbackPos);
            marker.setPosition(fallbackPos);
            marker.setTitle('Ubicaci贸n por defecto (CDMX) - Error en geolocalizaci贸n');
            
            var infoWindow = new google.maps.InfoWindow({
                content: '<div><strong>Ubicaci贸n por defecto</strong><br>No se pudo obtener ubicaci贸n real</div>'
            });
            infoWindow.open(map, marker);
        }

        function setUserLocation() {
            // Funci贸n legacy, redirigir a la nueva
            obtenerUbicacionConFallback();
        }

        function guardarUbicacion(pos) {
            var hoy = new Date().toISOString().slice(0, 10);
            var key = 'recorrido_' + hoy;
            var recorrido = JSON.parse(localStorage.getItem(key) || '[]');
            recorrido.push({lat: pos.lat, lng: pos.lng, t: Date.now()});
            localStorage.setItem(key, JSON.stringify(recorrido));
        }
    </script>
    <!-- Reemplaza TU_API_KEY con tu clave de Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPn7ufBV8nVIAKNS6LaS4fjdylKxWeEOs&callback=initMap" async defer></script>
</body>
</html>
