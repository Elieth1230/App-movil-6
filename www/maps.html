<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa - Google Maps</title>
    <link rel="stylesheet" href="css/estilo.css">
</head>
<body>
    <div class="map-header">📍 Ubicación Actual</div>
    <div id="map" style="height: calc(100vh - 60px); width: 100vw;"></div>
    
    <div class="map-controls">
        <button id="btn-location" class="control-btn location-btn" title="Obtener mi ubicación">📍</button>
    </div>
    <script>
        var map, marker;
        
        // Función para verificar permisos de ubicación
        function verificarPermisos() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('Estado del permiso de geolocalización:', result.state);
                    if (result.state === 'denied') {
                        alert('Los permisos de ubicación están denegados. Ve a Configuración > Apps > Proyecto6 > Permisos y habilita la Ubicación.');
                    }
                });
            }
        }
        
        function initMap() {
            var defaultCenter = { lat: 19.432608, lng: -99.133209 }; // CDMX por defecto
            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultCenter,
                zoom: 15,
                mapTypeId: 'roadmap',
                streetViewControl: false,
                fullscreenControl: false
            });
            marker = new google.maps.Marker({
                position: defaultCenter,
                map: map,
                title: 'Ubicación inicial'
            });
            
            // Verificar permisos primero
            verificarPermisos();
            
            // Intentar obtener ubicación después de un pequeño delay
            setTimeout(setUserLocation, 1000);
            
            document.getElementById('btn-location').addEventListener('click', setUserLocation);
        }

        function setUserLocation() {
            if (navigator.geolocation) {
                // Mostrar mensaje de carga
                console.log('Obteniendo ubicación...');
                
                navigator.geolocation.getCurrentPosition(function(position) {
                    var userPos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userPos);
                    marker.setPosition(userPos);
                    marker.setTitle('Tu ubicación actual');
                    guardarUbicacion(userPos);
                    console.log('Ubicación obtenida:', userPos);
                }, function(error) {
                    console.error('Error de geolocalización:', error);
                    var errorMsg = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Permisos de ubicación denegados. Por favor, habilita los permisos de ubicación en la configuración de la app.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Información de ubicación no disponible. Verifica que el GPS esté activado.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Tiempo de espera agotado. Intentando de nuevo...';
                            // Intentar de nuevo automáticamente
                            setTimeout(setUserLocation, 2000);
                            return;
                        default:
                            errorMsg = 'Error desconocido al obtener ubicación.';
                            break;
                    }
                    alert(errorMsg);
                    
                    // Como fallback, usar una ubicación por defecto (CDMX)
                    var fallbackPos = { lat: 19.432608, lng: -99.133209 };
                    map.setCenter(fallbackPos);
                    marker.setPosition(fallbackPos);
                    marker.setTitle('Ubicación por defecto (CDMX)');
                }, {
                    enableHighAccuracy: true,
                    timeout: 15000, // Aumentar timeout a 15 segundos
                    maximumAge: 60000 // Aceptar ubicación de hasta 1 minuto de antigüedad
                });
            } else {
                alert('Geolocalización no soportada por este dispositivo');
                // Usar ubicación por defecto
                var fallbackPos = { lat: 19.432608, lng: -99.133209 };
                map.setCenter(fallbackPos);
                marker.setPosition(fallbackPos);
                marker.setTitle('Ubicación por defecto (CDMX)');
            }
        }

        function guardarUbicacion(pos) {
            var hoy = new Date().toISOString().slice(0, 10);
            var key = 'recorrido_' + hoy;
            var recorrido = JSON.parse(localStorage.getItem(key) || '[]');
            recorrido.push({lat: pos.lat, lng: pos.lng, t: Date.now()});
            localStorage.setItem(key, JSON.stringify(recorrido));
        }
    </script>
    <!-- Reemplaza TU_API_KEY con tu clave de Google Maps JavaScript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDPn7ufBV8nVIAKNS6LaS4fjdylKxWeEOs&callback=initMap" async defer></script>
</body>
</html>
