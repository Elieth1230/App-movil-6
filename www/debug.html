<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Geolocalizaci√≥n</title>
    <link rel="stylesheet" href="css/estilo.css">
    <style>
        .debug-container {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .coords {
            background-color: #f8f9fa;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug Geolocalizaci√≥n</h1>
        
        <div id="status" class="status info">
            Esperando prueba de geolocalizaci√≥n...
        </div>
        
        <div class="coords" id="results">
            <h3>Resultados:</h3>
            <div id="coords-display">No hay coordenadas disponibles</div>
        </div>
        
        <button onclick="testGeolocation()">üìç Probar Geolocalizaci√≥n</button>
        <button onclick="testPermissions()">üîí Verificar Permisos</button>
        <button onclick="testGoogleMaps()">üó∫Ô∏è Probar Google Maps</button>
        <button onclick="forceLocationRefresh()">üîÑ Forzar Actualizaci√≥n</button>
        <button onclick="testDeviceInfo()">üì± Info del Dispositivo</button>
        <button onclick="clearResults()">üßπ Limpiar</button>
        
        <div id="log" style="background: #000; color: #0f0; padding: 10px; margin-top: 20px; border-radius: 5px; font-family: monospace; height: 200px; overflow-y: scroll;">
            <div>üì± Log de debug iniciado...</div>
        </div>
    </div>

    <script>
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            log(`Status: ${message}`);
        }

        function testPermissions() {
            log('üîí Verificando permisos...');
            updateStatus('Verificando permisos...', 'info');
            
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    log(`Permiso de geolocalizaci√≥n: ${result.state}`);
                    if (result.state === 'granted') {
                        updateStatus('‚úÖ Permisos concedidos', 'success');
                    } else if (result.state === 'denied') {
                        updateStatus('‚ùå Permisos denegados', 'error');
                    } else {
                        updateStatus('‚ö†Ô∏è Permisos pendientes', 'info');
                    }
                }).catch(function(error) {
                    log(`Error verificando permisos: ${error.message}`);
                    updateStatus('Error verificando permisos', 'error');
                });
            } else {
                log('API de permisos no disponible');
                updateStatus('API de permisos no disponible', 'error');
            }
        }

        function testGeolocation() {
            log('üìç Iniciando prueba de geolocalizaci√≥n...');
            updateStatus('Obteniendo ubicaci√≥n...', 'info');
            
            if (!navigator.geolocation) {
                log('‚ùå Geolocalizaci√≥n no soportada');
                updateStatus('‚ùå Geolocalizaci√≥n no soportada', 'error');
                return;
            }

            // Primero verificar si estamos en Cordova
            const isCordova = typeof cordova !== 'undefined';
            log(`üì± Entorno: ${isCordova ? 'Cordova/PhoneGap' : 'Navegador web'}`);

            // Configuraci√≥n m√°s agresiva para ubicaci√≥n real
            const options = {
                enableHighAccuracy: true,
                timeout: 60000, // Aumentar a 60 segundos
                maximumAge: 0    // No usar cach√©
            };

            log('Configuraci√≥n: enableHighAccuracy=true, timeout=60s, maximumAge=0');
            log('üîÑ Intentando obtener ubicaci√≥n (esto puede tomar hasta 60 segundos)...');
            
            // Usar watchPosition en lugar de getCurrentPosition para mejor precisi√≥n
            const watchId = navigator.geolocation.watchPosition(
                function(position) {
                    navigator.geolocation.clearWatch(watchId);
                    log('‚úÖ Ubicaci√≥n obtenida exitosamente');
                    const coords = position.coords;
                    
                    const coordsDisplay = document.getElementById('coords-display');
                    coordsDisplay.innerHTML = `
                        <strong>Coordenadas obtenidas:</strong><br>
                        üìç Latitud: ${coords.latitude}<br>
                        üìç Longitud: ${coords.longitude}<br>
                        üéØ Precisi√≥n: ${Math.round(coords.accuracy)} metros<br>
                        ‚è∞ Timestamp: ${new Date(position.timestamp).toLocaleString()}<br>
                        ${coords.altitude ? `üèîÔ∏è Altitud: ${coords.altitude} m<br>` : ''}
                        ${coords.altitudeAccuracy ? `üèîÔ∏è Precisi√≥n altitud: ${coords.altitudeAccuracy} m<br>` : ''}
                        ${coords.heading ? `üß≠ Direcci√≥n: ${coords.heading}¬∞<br>` : ''}
                        ${coords.speed ? `üöó Velocidad: ${coords.speed} m/s<br>` : ''}
                        <br><strong>Diagn√≥stico:</strong><br>
                        üîã Cordova: ${isCordova ? 'S√≠' : 'No'}<br>
                        üì° Fuente: ${coords.accuracy < 100 ? 'GPS' : 'Red/WiFi'}<br>
                    `;
                    
                    // Verificar si no es la ubicaci√≥n por defecto de CDMX
                    const defaultLat = 19.432608;
                    const defaultLng = -99.133209;
                    const distance = calculateDistance(coords.latitude, coords.longitude, defaultLat, defaultLng);
                    
                    log(`üìè Distancia desde CDMX: ${distance.toFixed(2)} km`);
                    
                    if (distance < 1) { // Menos de 1km de la ubicaci√≥n por defecto
                        log('‚ö†Ô∏è ADVERTENCIA: Muy cerca de ubicaci√≥n por defecto de CDMX');
                        updateStatus('‚ö†Ô∏è Posible ubicaci√≥n por defecto', 'error');
                        coordsDisplay.innerHTML += `<br><span style="color: red;">‚ö†Ô∏è Distancia desde ubicaci√≥n por defecto: ${distance.toFixed(2)} km</span>`;
                    } else {
                        log('‚úÖ Coordenadas reales obtenidas (distancia significativa de CDMX)');
                        updateStatus(`‚úÖ Ubicaci√≥n real (${Math.round(coords.accuracy)}m precisi√≥n)`, 'success');
                        coordsDisplay.innerHTML += `<br><span style="color: green;">‚úÖ Ubicaci√≥n real confirmada</span>`;
                    }
                    
                    // Intentar geocodificaci√≥n inversa
                    reverseGeocode(coords.latitude, coords.longitude);
                },
                function(error) {
                    navigator.geolocation.clearWatch(watchId);
                    log(`‚ùå Error de geolocalizaci√≥n: ${error.message}`);
                    log(`üìä C√≥digo de error: ${error.code}`);
                    
                    let errorMsg = '';
                    let solution = '';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = '‚ùå Permisos denegados';
                            solution = 'Ve a Configuraci√≥n > Apps > Proyecto6 > Permisos > Ubicaci√≥n > Permitir';
                            log('Causa: Usuario deneg√≥ permisos de ubicaci√≥n');
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = '‚ùå Ubicaci√≥n no disponible';
                            solution = 'Activa el GPS y verifica conexi√≥n a internet';
                            log('Causa: Informaci√≥n de ubicaci√≥n no disponible');
                            break;
                        case error.TIMEOUT:
                            errorMsg = '‚ùå Tiempo agotado (60s)';
                            solution = 'Prueba en exterior con mejor se√±al GPS';
                            log('Causa: Timeout despu√©s de 60 segundos');
                            break;
                        default:
                            errorMsg = '‚ùå Error desconocido';
                            solution = 'Reinicia la app y vuelve a intentar';
                            log(`Causa: Error desconocido (${error.code})`);
                            break;
                    }
                    updateStatus(errorMsg, 'error');
                    
                    const coordsDisplay = document.getElementById('coords-display');
                    coordsDisplay.innerHTML = `
                        <strong>Error de geolocalizaci√≥n:</strong><br>
                        ${errorMsg}<br><br>
                        <strong>Soluci√≥n sugerida:</strong><br>
                        ${solution}
                    `;
                },
                options
            );
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function reverseGeocode(lat, lng) {
            log('üåç Intentando geocodificaci√≥n inversa...');
            const geocoder = new google.maps.Geocoder();
            const latlng = { lat: lat, lng: lng };
            
            geocoder.geocode({ location: latlng }, function(results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        const address = results[0].formatted_address;
                        log(`üìç Direcci√≥n: ${address}`);
                        const coordsDisplay = document.getElementById('coords-display');
                        coordsDisplay.innerHTML += `<br><strong>üìç Direcci√≥n:</strong><br>${address}`;
                    }
                } else {
                    log(`‚ùå Error en geocodificaci√≥n: ${status}`);
                }
            });
        }

        function testGoogleMaps() {
            log('üó∫Ô∏è Verificando Google Maps API...');
            updateStatus('Verificando Google Maps...', 'info');
            
            if (typeof google !== 'undefined' && google.maps) {
                log('‚úÖ Google Maps API cargada correctamente');
                updateStatus('‚úÖ Google Maps API disponible', 'success');
            } else {
                log('‚ùå Google Maps API no cargada');
                updateStatus('‚ùå Google Maps API no disponible', 'error');
                
                // Intentar cargar Google Maps
                const script = document.createElement('script');
                script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDPn7ufBV8nVIAKNS6LaS4fjdylKxWeEOs';
                script.onload = function() {
                    log('‚úÖ Google Maps API cargada din√°micamente');
                    updateStatus('‚úÖ Google Maps API cargada', 'success');
                };
                script.onerror = function() {
                    log('‚ùå Error cargando Google Maps API');
                    updateStatus('‚ùå Error con API Key de Google Maps', 'error');
                };
                document.head.appendChild(script);
            }
        }

        function forceLocationRefresh() {
            log('üîÑ Forzando actualizaci√≥n de ubicaci√≥n...');
            updateStatus('Forzando actualizaci√≥n...', 'info');
            
            // Limpiar cualquier cach√© de ubicaci√≥n
            if (navigator.geolocation.clearWatch) {
                navigator.geolocation.clearWatch();
            }
            
            // Configuraci√≥n m√°s agresiva
            const options = {
                enableHighAccuracy: true,
                timeout: 120000, // 2 minutos
                maximumAge: 0,   // Sin cach√©
                // Opciones espec√≠ficas de Cordova si est√°n disponibles
                frequency: 1000,
                enableLocationManager: true
            };
            
            log('üîß Usando configuraci√≥n agresiva: timeout=120s, sin cach√©');
            
            let attempts = 0;
            const maxAttempts = 3;
            
            function attemptLocation() {
                attempts++;
                log(`üîÑ Intento ${attempts} de ${maxAttempts}`);
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        log(`‚úÖ √âxito en intento ${attempts}`);
                        const coords = position.coords;
                        
                        // Verificar calidad de la ubicaci√≥n
                        const quality = coords.accuracy < 50 ? 'üü¢ Excelente' : 
                                      coords.accuracy < 100 ? 'üü° Buena' : 
                                      coords.accuracy < 500 ? 'üü† Regular' : 'üî¥ Pobre';
                        
                        const coordsDisplay = document.getElementById('coords-display');
                        coordsDisplay.innerHTML = `
                            <strong>üì° Ubicaci√≥n forzada (Intento ${attempts}):</strong><br>
                            üìç Latitud: ${coords.latitude}<br>
                            üìç Longitud: ${coords.longitude}<br>
                            üéØ Precisi√≥n: ${Math.round(coords.accuracy)} metros ${quality}<br>
                            ‚è∞ Timestamp: ${new Date(position.timestamp).toLocaleString()}<br>
                            <br><strong>üî¨ An√°lisis t√©cnico:</strong><br>
                            üìä Calidad se√±al: ${quality}<br>
                            üõ∞Ô∏è Fuente probable: ${coords.accuracy < 100 ? 'GPS Satelital' : 'Torres celulares/WiFi'}<br>
                            ‚ö° Tiempo respuesta: ${attempts > 1 ? 'M√∫ltiples intentos' : 'Primer intento'}<br>
                        `;
                        
                        const distance = calculateDistance(coords.latitude, coords.longitude, 19.432608, -99.133209);
                        coordsDisplay.innerHTML += `<br>üìè Distancia desde CDMX: ${distance.toFixed(2)} km`;
                        
                        if (distance < 5) {
                            coordsDisplay.innerHTML += `<br><span style="color: orange;">‚ö†Ô∏è Muy cerca de CDMX - ¬øEst√°s realmente en Ciudad de M√©xico?</span>`;
                            updateStatus('‚ö†Ô∏è Ubicaci√≥n cerca de CDMX detectada', 'error');
                        } else {
                            coordsDisplay.innerHTML += `<br><span style="color: green;">‚úÖ Ubicaci√≥n fuera de CDMX confirmada</span>`;
                            updateStatus(`‚úÖ Ubicaci√≥n real confirmada (${distance.toFixed(0)}km de CDMX)`, 'success');
                        }
                        
                        reverseGeocode(coords.latitude, coords.longitude);
                    },
                    function(error) {
                        log(`‚ùå Error en intento ${attempts}: ${error.message}`);
                        
                        if (attempts < maxAttempts) {
                            log(`üîÑ Reintentando en 3 segundos...`);
                            setTimeout(attemptLocation, 3000);
                        } else {
                            log('‚ùå Todos los intentos fallaron');
                            updateStatus('‚ùå Fallo tras m√∫ltiples intentos', 'error');
                            
                            const coordsDisplay = document.getElementById('coords-display');
                            coordsDisplay.innerHTML = `
                                <strong>‚ùå Error persistente despu√©s de ${maxAttempts} intentos:</strong><br>
                                C√≥digo: ${error.code}<br>
                                Mensaje: ${error.message}<br><br>
                                <strong>üõ†Ô∏è Pasos para resolver:</strong><br>
                                1. Ve a Configuraci√≥n > Ubicaci√≥n > Activar<br>
                                2. Ve a Configuraci√≥n > Apps > Proyecto6 > Permisos > Ubicaci√≥n > Permitir siempre<br>
                                3. Sal al exterior para mejor se√±al GPS<br>
                                4. Reinicia la aplicaci√≥n<br>
                                5. Aseg√∫rate que tienes conexi√≥n a internet<br>
                            `;
                        }
                    },
                    options
                );
            }
            
            attemptLocation();
        }

        function testDeviceInfo() {
            log('üì± Obteniendo informaci√≥n del dispositivo...');
            updateStatus('Analizando dispositivo...', 'info');
            
            const coordsDisplay = document.getElementById('coords-display');
            let deviceInfo = '<strong>üì± Informaci√≥n del dispositivo:</strong><br>';
            
            // Informaci√≥n b√°sica
            deviceInfo += `üåê User Agent: ${navigator.userAgent}<br>`;
            deviceInfo += `üìç Geolocation API: ${navigator.geolocation ? '‚úÖ Disponible' : '‚ùå No disponible'}<br>`;
            deviceInfo += `üì± Cordova: ${typeof cordova !== 'undefined' ? '‚úÖ Detectado' : '‚ùå No detectado'}<br>`;
            deviceInfo += `üîå Online: ${navigator.onLine ? '‚úÖ Conectado' : '‚ùå Sin conexi√≥n'}<br>`;
            
            // Informaci√≥n de conexi√≥n
            if (navigator.connection) {
                deviceInfo += `üì∂ Tipo conexi√≥n: ${navigator.connection.effectiveType || navigator.connection.type || 'Desconocido'}<br>`;
            }
            
            // Informaci√≥n de permisos
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    deviceInfo += `üîí Permiso geolocalizaci√≥n: ${result.state}<br>`;
                    coordsDisplay.innerHTML = deviceInfo;
                }).catch(function() {
                    deviceInfo += `üîí Permiso geolocalizaci√≥n: No se puede verificar<br>`;
                    coordsDisplay.innerHTML = deviceInfo;
                });
            } else {
                deviceInfo += `üîí API Permisos: No disponible<br>`;
                coordsDisplay.innerHTML = deviceInfo;
            }
            
            // Verificar plugins de Cordova
            if (typeof cordova !== 'undefined') {
                deviceInfo += `<br><strong>üîå Plugins Cordova:</strong><br>`;
                if (typeof device !== 'undefined') {
                    deviceInfo += `üì± Modelo: ${device.model || 'Desconocido'}<br>`;
                    deviceInfo += `ü§ñ Plataforma: ${device.platform || 'Desconocida'}<br>`;
                    deviceInfo += `üìä Versi√≥n: ${device.version || 'Desconocida'}<br>`;
                }
            }
            
            coordsDisplay.innerHTML = deviceInfo;
            log('üì± Informaci√≥n del dispositivo obtenida');
        }

        function clearResults() {
            document.getElementById('coords-display').textContent = 'No hay coordenadas disponibles';
            document.getElementById('log').innerHTML = '<div>üì± Log limpiado...</div>';
            updateStatus('Log limpiado', 'info');
        }

        // Auto-verificar al cargar
        window.onload = function() {
            log('üöÄ P√°gina de debug cargada');
            log('üîç Iniciando diagn√≥stico autom√°tico...');
            testPermissions();
            testDeviceInfo();
        };
    </script>
</body>
</html>
